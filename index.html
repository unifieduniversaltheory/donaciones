<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Donaciones ‚Äì Proyecto de Investigaci√≥n</title>
<link rel="icon" type="image/png" href="favicon.png" />
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>
<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f5f5f7;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #111827;
    color: #fff;
    padding: 35px;
    text-align: center;
  }
  header h1 { margin: 0; font-size: 28px; }
  .container {
    max-width: 820px;
    margin: 40px auto;
    background: #fff;
    padding: 40px;
    border-radius: 14px;
    box-shadow: 0 0 25px rgba(0,0,0,0.08);
  }
  h2, h3 { margin-top: 0; }
  input, select, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 17px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { background: #1e40af; }
  .lang-switch {
    text-align: right;
    margin-bottom: 10px;
  }
  .note {
    font-size: 14px;
    color: #444;
    margin-top: 15px;
  }
  .success {
    background: #d1fae5;
    color: #065f46;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .error {
    background: #fee2e2;
    color: #991b1b;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
</style>
</head>
<body>
<header>
  <h1 id="title">Donaciones ‚Äì Proyecto de Investigaci√≥n</h1>
</header>
<div class="container">

<div class="lang-switch">
    <select id="language">
      <option value="es">Espa√±ol</option>
      <option value="en">English</option>
    </select>
</div>

<p id="intro">
  Este formulario permite realizar una <strong>donaci√≥n voluntaria</strong> para apoyar este proyecto cient√≠fico. No existe, ni existir√°, retorno econ√≥mico, lucro, dividendos ni beneficios financieros. Toda contribuci√≥n se utiliza exclusivamente para investigaci√≥n, mantenimiento estructural y capacitaci√≥n.
</p>

<p id="data-note">
  Si lo deseas, puedes dejar tus datos para ser mencionado en la lista oficial de colaboradores del proyecto.
</p>

<button id="connectBtn">Conectar Wallet</button>
<div id="status" class="success"></div>
<div id="errorMsg" class="error"></div>

<h3 id="yourAddressLabel">Tu direcci√≥n:</h3>
<div id="userAddress">‚Äî</div>

<h3 id="yourUSDTLabel">Saldo USDT:</h3>
<div id="userUSDT">‚Äî</div>

<h3 id="yourSYMLabel">Saldo Token Simb√≥lico:</h3>
<div id="userSYM">‚Äî</div>

<hr>
<h3 id="donateTitle">Realizar donaci√≥n</h3>
<input type="number" id="donationAmount" placeholder="Monto en USDT (ej: 1.5)" />
<button id="approveBtn">Aprobar USDT</button>
<button id="donateBtn">Donar</button>

<p class="note" id="rateNote">
  Recibir√°s 1 token simb√≥lico por cada 1 USDT donado. Este token es simb√≥lico y no representa valor financiero.
</p>

<hr>
<h3 id="collabTitle">Colaboradores</h3>
<p id="collabText">Si deseas ser incluido en la lista p√∫blica de colaboradores, ingresa tus datos. T√∫ eliges el nivel de privacidad.</p>

<label><input type="radio" name="privacy" value="public_full" checked> P√∫blico (nombre y pa√≠s)</label><br>
<label><input type="radio" name="privacy" value="public_name"> P√∫blico (solo nombre)</label><br>
<label><input type="radio" name="privacy" value="private"> Privado (no mostrar)</label><br><br>

<input type="text" id="collabName" placeholder="Tu nombre" />
<input type="text" id="collabCountry" placeholder="Pa√≠s (opcional)" />
<input type="text" id="collabCity" placeholder="Ciudad (opcional)" />
<input type="number" id="collabAge" placeholder="Edad (opcional)" />
<textarea id="collabComment" placeholder="Comentario (opcional)" style="width:100%;height:80px;margin-top:10px;"></textarea>
<input type="email" id="collabEmail" placeholder="Correo (solo si deseas recibir una respuesta)" />
<button id="sendCollab">Enviar datos</button>

<hr>
<h3 id="howToImportTitle">¬øC√≥mo ver tu token UUT?</h3>
<p id="howToImportText">
  Si no ves tus tokens luego de donar, abre MetaMask ‚Üí "Import Tokens" ‚Üí pega la siguiente direcci√≥n:<br>
  <strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>
  El token aparecer√° autom√°ticamente con el s√≠mbolo UUT.
</p>

<h3 id="transparencyTitle">Transparencia y declaraci√≥n de no lucro</h3>
<p id="transparencyText">
  Este proyecto se sostiene √≠ntegramente mediante donaciones. Ning√∫n aporte genera retorno, dividendos ni beneficios financieros. Todos los fondos se destinan exclusivamente a investigaci√≥n cient√≠fica, mantenimiento de infraestructura, insumos, capacitaci√≥n, divulgaci√≥n y sostenimiento operativo. Toda la gesti√≥n financiera es transparente y puede ser auditada en la blockchain.
</p>

<hr>
<h3 id="publicListTitle">Colaboradores P√∫blicos</h3>
<div id="publicCollabList">Cargando...</div>
</div>
<script>const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwMvNpT-SGBzVdf0n1Bd0m6jlIcXWaTYxSTAhwH7wDfG319Gqr8OOziBa-xRgOXh1QV/exec";

// ========================= CONFIG ============================
const USDT_ADDRESS = "0x55d398326f99059fF775485246999027B3197955";
const SYM_ADDRESS  = "0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3";
const DONATION_ADDRESS = "0x524C8B19d28d4C24E73cd2126E3C6b87A40EdD0f";

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function balanceOf(address) external view returns (uint256)",
  "function decimals() external view returns (uint8)"
];

const DONATION_ABI = [
  "function donate(uint256 amountUSDT) external"
];

let provider, signer, userAddress;

// ====================== MULTI-LANGUAGE ========================
const texts = {
  es: {
    title: "Donaciones ‚Äì Proyecto de Investigaci√≥n",
    intro: "Este formulario permite realizar una <strong>donaci√≥n voluntaria</strong>...",
    dataNote: "Si lo deseas, puedes dejar tus datos...",
    yourAddressLabel: "Tu direcci√≥n:",
    yourUSDTLabel: "Saldo USDT:",
    yourSYMLabel: "Saldo Token Simb√≥lico:",
    donateTitle: "Realizar donaci√≥n",
    rateNote: "Recibir√°s 1 token simb√≥lico...",
    connectBtn: "Conectar Wallet",
    approveBtn: "Aprobar USDT",
    donateBtn: "Donar",
    collabSent: "Datos enviados correctamente."
  },
  en: {
    title: "Donations ‚Äì Research Project",
    intro: "This form allows you to make a <strong>voluntary donation</strong>...",
    dataNote: "If you wish, you may leave your information...",
    yourAddressLabel: "Your address:",
    yourUSDTLabel: "USDT Balance:",
    yourSYMLabel: "Symbolic Token Balance:",
    donateTitle: "Make a Donation",
    rateNote: "You will receive 1 symbolic token...",
    connectBtn: "Connect Wallet",
    approveBtn: "Approve USDT",
    donateBtn: "Donate",
    collabSent: "Data submitted successfully."
  }
};

document.getElementById("language").onchange = applyLanguage;
applyLanguage();

function applyLanguage() {
  const lang = document.getElementById("language").value;
  const t = texts[lang];
  document.getElementById("title").innerText = t.title;
  document.getElementById("intro").innerHTML = t.intro;
  document.getElementById("data-note").innerText = t.dataNote;
  document.getElementById("yourAddressLabel").innerText = t.yourAddressLabel;
  document.getElementById("yourUSDTLabel").innerText = t.yourUSDTLabel;
  document.getElementById("yourSYMLabel").innerText = t.yourSYMLabel;
  document.getElementById("donateTitle").innerText = t.donateTitle;
  document.getElementById("rateNote").innerText = t.rateNote;
  document.getElementById("connectBtn").innerText = t.connectBtn;
  document.getElementById("approveBtn").innerText = t.approveBtn;
  document.getElementById("donateBtn").innerText = t.donateBtn;
}

// ====================== CONNECT WALLET ========================
document.getElementById("connectBtn").onclick = async () => {
  if (typeof window.ethereum === "undefined") {
    alert("No se detect√≥ MetaMask.");
    return;
  }

  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();

  document.getElementById("userAddress").innerText = userAddress;
  actualizarBalances();
};

// ====================== BALANCES ===============================
async function actualizarBalances() {
  const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
  const sym  = new ethers.Contract(SYM_ADDRESS, ERC20_ABI, provider);

  const usdtDec = await usdt.decimals();
  const symDec  = await sym.decimals();

  const balUSDT = await usdt.balanceOf(userAddress);
  const balSYM  = await sym.balanceOf(userAddress);

  document.getElementById("userUSDT").innerText =
    ethers.utils.formatUnits(balUSDT, usdtDec) + " USDT";

  document.getElementById("userSYM").innerText =
    ethers.utils.formatUnits(balSYM, symDec) + " UUT";
}

// ====================== APPROVE ===============================
document.getElementById("approveBtn").onclick = async () => {
  const amountInput = document.getElementById("donationAmount").value;
  if (!amountInput || amountInput <= 0) {
    alert("Monto inv√°lido.");
    return;
  }

  const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
  const decimals = await usdt.decimals();
  const amountWei = ethers.utils.parseUnits(amountInput, decimals);

  const tx = await usdt.approve(DONATION_ADDRESS, amountWei);
  alert("Approve enviado.");
  await tx.wait();
  alert("Approve completado.");
};

// ====================== DONATE ===============================
document.getElementById("donateBtn").onclick = async () => {
  const amountInput = document.getElementById("donationAmount").value;
  if (!amountInput || amountInput <= 0) {
    alert("Monto inv√°lido.");
    return;
  }

  const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
  const decimals = await usdt.decimals();
  const amountWei = ethers.utils.parseUnits(amountInput, decimals);

  const donation = new ethers.Contract(DONATION_ADDRESS, DONATION_ABI, signer);
  const tx = await donation.donate(amountWei);
  alert("Donaci√≥n enviada.");
  await tx.wait();
  alert("Donaci√≥n completada. Gracias!");
  actualizarBalances();
};

// ====================== SEND COLLAB DATA ======================
document.getElementById("sendCollab").onclick = async () => {
  const privacy = document.querySelector("input[name='privacy']:checked").value;

  const payload = {
    wallet: userAddress || "",
    nombre: document.getElementById("collabName").value,
    email: document.getElementById("collabEmail").value,
    privacidad: privacy,
    pais: document.getElementById("collabCountry").value,
    ciudad: document.getElementById("collabCity").value,
    edad: document.getElementById("collabAge").value,
    comentario: document.getElementById("collabComment").value
  };

  const res = await fetch(GOOGLE_WEBAPP_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify(payload)
  });

  alert("Datos enviados. ¬°Gracias por colaborar!");
};
async function cargarColaboradoresPublicos() {
  const contenedor = document.getElementById("publicCollabList");
  contenedor.textContent = "Cargando...";

  try {
    const res = await fetch(GOOGLE_WEBAPP_URL); // GET -> doGet
    const data = await res.json(); // es un array de { nombre, pais, modo }

    contenedor.innerHTML = ""; // limpiamos contenido est√°tico

    if (!data.length) {
      contenedor.textContent = "Todav√≠a no hay colaboradores p√∫blicos.";
      return;
    }

    data.forEach(c => {
      const card = document.createElement("div");
      card.className = "collab-card";
      card.style.padding = "8px 0";

      const line = document.createElement("div");

      // Armamos el texto seg√∫n privacidad, pero SIEMPRE como texto.
      let texto = c.nombre || "";
      if (c.modo === "public_full" && c.pais) {
        texto += " (" + c.pais + ")";
      }

      line.textContent = texto; // üëà esto protege contra XSS
      card.appendChild(line);
      contenedor.appendChild(card);
    });

  } catch (err) {
    contenedor.textContent = "No se pudo cargar la lista de colaboradores.";
    console.error(err);
  }
}

// Llamar al cargar la p√°gina
cargarColaboradoresPublicos();

</script>
</body>
</html>
