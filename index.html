<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Donaciones – Proyecto de Investigación</title>
<link rel="icon" type="image/png" href="favicon.png" />
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f5f5f7;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #111827;
    color: #fff;
    padding: 35px;
    text-align: center;
  }
  header h1 { margin: 0; font-size: 28px; }
  .container {
    max-width: 820px;
    margin: 40px auto;
    background: #fff;
    padding: 40px;
    border-radius: 14px;
    box-shadow: 0 0 25px rgba(0,0,0,0.08);
  }
  h2, h3 { margin-top: 0; }
  input, select, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 17px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { background: #1e40af; }
  .lang-switch {
    text-align: right;
    margin-bottom: 10px;
  }
  .note {
    font-size: 14px;
    color: #444;
    margin-top: 15px;
  }
  .success {
    background: #d1fae5;
    color: #065f46;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .error {
    background: #fee2e2;
    color: #991b1b;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  #collabPanel {
  transition: max-height 0.4s ease, opacity 0.4s ease;
  overflow: hidden;
}

#collabPanel.collapsed {
  max-height: 0;
  opacity: 0;
  pointer-events: none;
}

#collabPanel.expanded {
  max-height: 1000px; /* algo grande para que entre todo */
  opacity: 1;
  pointer-events: auto;
}

</style>
</head>
<body>
<header>
  <h1 id="title">Donaciones – Proyecto de Investigación</h1>
</header>
<div class="container">

<div class="lang-switch">
    <select id="language">
      <option value="es">Español</option>
      <option value="en">English</option>
    </select>
</div>

<p id="intro">
  Este formulario permite realizar una <strong>donación voluntaria</strong> para apoyar este proyecto científico independiente.
  <br><br>
  <strong>IMPORTANTE:</strong> Toda contribución es una donación pura y desinteresada. No existe, ni existirá, retorno económico,
  participación en beneficios, intereses, dividendos, promesa de revalorización, ni ningún tipo de rendimiento financiero.
  Esta página <strong>no</strong> ofrece ni representa un instrumento de inversión.
</p>

<p class="note" id="noReturnNote">
  Al donar, declaras que comprendes y aceptas que:
  <br>• No hay devolución del dinero donado.
  <br>• No se generan derechos económicos de ningún tipo.
  <br>• El token UUT que recibes es un <strong>reconocimiento simbólico</strong> en la blockchain, sin valor financiero garantizado.
</p>

<p id="data-note">
  Si lo deseas, puedes dejar tus datos para ser mencionado en la lista oficial de colaboradores del proyecto.
</p>

<button id="connectBtn">Conectar Wallet</button>
<div id="status" class="success"></div>
<div id="errorMsg" class="error"></div>

<h3 id="yourAddressLabel">Tu dirección:</h3>
<div id="userAddress">—</div>

<h3 id="yourUSDTLabel">Saldo USDT:</h3>
<div id="userUSDT">—</div>

<h3 id="yourSYMLabel">Token UUT (simbólico):</h3>
<!-- <div id="userSYM">—</div>-->

<hr>
<h3 id="donateTitle">Realizar donación</h3>

<p class="note" id="donateWarning">
  Antes de donar, asegúrate de estar conectado a la red <strong>BNB Smart Chain (BSC)</strong> en tu Billetera y de comprender que esta operación es una donación sin retorno económico.
</p>

<input type="number" id="donationAmount" placeholder="Monto en USDT (ej: 1.5)" />
<button id="approveBtn">Aprobar USDT</button>
<button id="donateBtn">Donar</button>
<div id="statusBottom" class="success"></div>
<div id="errorMsgBottom" class="error"></div>
<p class="note" id="rateNote">
  Recibirás <strong>1 token UUT simbólico por cada 1 USDT donado</strong>.
  Este token es únicamente un reconocimiento simbólico en la red y <strong>no representa ni garantiza valor financiero, derechos sobre el proyecto ni participación en beneficios</strong>.
</p>

<hr>

<div id="collabPanel" class="collapsed">
  <h3 id="collabTitle">Colaboradores</h3>
  <p id="collabText">Si deseas ser incluido en la lista pública de colaboradores, ingresa tus datos. Tú eliges el nivel de privacidad.</p>

<label>
  <input type="radio" name="privacy" value="public_full" checked>
  <span id="privacyPublicFullLabel">Público (nombre y país)</span>
</label><br>

<label>
  <input type="radio" name="privacy" value="public_name">
  <span id="privacyPublicNameLabel">Público (solo nombre)</span>
</label><br>

<label>
  <input type="radio" name="privacy" value="private">
  <span id="privacyPrivateLabel">Privado (no mostrar)</span>
</label><br><br>

  <input type="text" id="collabName" name="collabName" autocomplete="name" placeholder="Tu nombre" />
  <input type="text" id="collabCountry" placeholder="País (opcional)" autocomplete="country-name" />
  <input type="text" id="collabCity" placeholder="Ciudad (opcional)" autocomplete="address-level2" />
  <input type="number" id="collabAge" placeholder="Edad (opcional)" />
  <textarea id="collabComment" placeholder="Comentario (opcional)" style="width:100%;height:80px;margin-top:10px;"></textarea>
  <input type="email" id="collabEmail" name="collabEmail" autocomplete="email" placeholder="Correo (solo si deseas recibir una respuesta)" />
  <button id="sendCollab">Enviar datos</button>
</div>


<hr>
<h3 id="howToImportTitle">¿Cómo ver tu token UUT?</h3>
<p id="howToImportText">
  Si no ves tus tokens luego de donar, abre tu billetera → "Import Tokens" → pega la siguiente dirección:<br>
  <strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>
  El token aparecerá automáticamente con el símbolo <strong>UUT</strong>.
</p>

<h3 id="transparencyTitle">Transparencia y declaración de no lucro</h3>
<p id="transparencyText">
  Este proyecto se sostiene íntegramente mediante donaciones. Ningún aporte genera retorno, dividendos ni beneficios financieros.
  Todos los fondos se destinan exclusivamente a investigación científica, mantenimiento de infraestructura, insumos, capacitación,
  divulgación y sostenimiento operativo. Toda la gestión financiera es transparente y puede ser auditada en la blockchain.
</p>

<hr>
<h3 id="publicListTitle">Colaboradores Públicos</h3>
<div id="publicCollabList">Cargando...</div>
</div>

<script>
// URL de tu Google Apps Script
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzThyBT4-GsQV-OZS_dpR7MTaqescPfxRLsoMCw95k_bDX5v8zWW4ela8xFwixjYfhd/exec";

// ========================= CONFIG ============================
const USDT_ADDRESS      = "0x55d398326f99059fF775485246999027B3197955"; // USDT en BNB Smart Chain
const SYM_ADDRESS       = "0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3"; // Token UUT
const DONATION_ADDRESS  = "0x524C8B19d28d4C24E73cd2126E3C6b87A40EdD0f"; // Contrato de donaciones
const BSC_CHAIN_ID_HEX  = "0x38"; // 56 en decimal

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function balanceOf(address) external view returns (uint256)",
  "function decimals() external view returns (uint8)"
];

const DONATION_ABI = [
  "function donate(uint256 amountUSDT) external"
];

let provider, signer, userAddress;
let ultimoTxHash = "";
let ultimoMontoUSDT = "";

// Helpers de UI
const statusBox = document.getElementById("status");
const errorBox  = document.getElementById("errorMsg");

function showStatus(msg) {
  // Arriba
  statusBox.innerText = msg;
  statusBox.style.display = "block";
  errorBox.style.display = "none";

  // Abajo
  const b  = document.getElementById("statusBottom");
  const eb = document.getElementById("errorMsgBottom");
  if (b && eb) {
    b.innerText = msg;
    b.style.display = "block";
    eb.style.display = "none";

    // Scroll suave al bloque inferior de mensajes
    b.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

function showError(msg) {
  // Arriba
  errorBox.innerText = msg;
  errorBox.style.display = "block";
  statusBox.style.display = "none";

  // Abajo
  const b  = document.getElementById("statusBottom");
  const eb = document.getElementById("errorMsgBottom");
  if (b && eb) {
    eb.innerText = msg;
    eb.style.display = "block";
    b.style.display = "none";

    // Scroll suave al bloque inferior de mensajes
    eb.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}
// ====================== MULTI-LANGUAGE ========================
const texts = {
  es: {
    // Títulos y textos estáticos
    title: "Donaciones – Proyecto de Investigación",
    intro:
      "Este formulario permite realizar una <strong>donación voluntaria</strong> para apoyar este proyecto científico independiente.<br><br><strong>IMPORTANTE:</strong> Toda contribución es una donación pura y desinteresada. No existe, ni existirá, retorno económico, participación en beneficios, intereses, dividendos, promesa de revalorización, ni ningún tipo de rendimiento financiero. Esta página <strong>no</strong> ofrece ni representa un instrumento de inversión.",
    noReturnNote:
      "Al donar, declaras que comprendes y aceptas que:<br>• No hay devolución del dinero donado.<br>• No se generan derechos económicos de ningún tipo.<br>• El token UUT que recibes es un <strong>reconocimiento simbólico</strong> en la blockchain, sin valor financiero garantizado.",
    dataNote:
      "Si lo deseas, puedes dejar tus datos para ser mencionado en la lista oficial de colaboradores del proyecto.",
    yourAddressLabel: "Tu dirección:",
    yourUSDTLabel: "Saldo USDT:",
    yourSYMLabel: "Token UUT (simbólico):",
    donateTitle: "Realizar donación",
    rateNote:
      "Recibirás 1 token UUT simbólico por cada 1 USDT donado. El token es únicamente un reconocimiento en la blockchain y no representa ni garantiza valor financiero, derechos sobre el proyecto ni participación en beneficios.",
    connectBtn: "Conectar Wallet",
    approveBtn: "Aprobar USDT",
    donateBtn: "Donar",
    donateWarning:
      "Antes de donar, asegúrate de estar conectado a la red BNB Smart Chain (BSC) en tu billetera y de comprender que esta operación es una donación sin retorno económico.",

    // Sección colaboradores
    collabTitle: "Colaboradores",
    collabText:
      "Si deseas ser incluido en la lista pública de colaboradores, ingresa tus datos. Tú eliges el nivel de privacidad.",
    privacyPublicFull: "Público (nombre y país)",
    privacyPublicName: "Público (solo nombre)",
    privacyPrivate: "Privado (no mostrar)",
    collabNamePlaceholder: "Tu nombre",
    collabCountryPlaceholder: "País (opcional)",
    collabCityPlaceholder: "Ciudad (opcional)",
    collabAgePlaceholder: "Edad (opcional)",
    collabCommentPlaceholder: "Comentario (opcional)",
    collabEmailPlaceholder: "Correo (solo si deseas recibir una respuesta)",

    // Cómo ver el token
    howToImportTitle: "¿Cómo ver tu token UUT?",
    howToImportText:
      'Si no ves tus tokens luego de donar, abre tu billetera → "Import Tokens" → pega la siguiente dirección:<br><strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>El token aparecerá automáticamente con el símbolo <strong>UUT</strong>.',

    // Transparencia
    transparencyTitle: "Transparencia y declaración de no lucro",
    transparencyText:
      "Este proyecto se sostiene íntegramente mediante donaciones. Ningún aporte genera retorno, dividendos ni beneficios financieros. Todos los fondos se destinan exclusivamente a investigación científica, mantenimiento de infraestructura, insumos, capacitación, divulgación y sostenimiento operativo. Toda la gestión financiera es transparente y puede ser auditada en la blockchain.",

    // Lista pública
    publicListTitle: "Colaboradores Públicos",

    // Mensajes runtime – conexión de wallet
    statusWalletMissing:
      "No se detectó ninguna wallet compatible. Instala o habilita MetaMask (u otra wallet compatible).",
    statusWalletConnected:
      "Wallet conectada correctamente en BNB Smart Chain (BSC).",
    errorWalletConnect:
      "No se pudo conectar la wallet. Revisa tu wallet y vuelve a intentarlo.",
    warningWrongNetwork:
      "Atención: esta dApp está diseñada para la red BNB Smart Chain (BSC – chainId 56). Cambia la red en tu wallet.",

    // Mensajes runtime – balances
    balanceError:
      "No se pudieron actualizar los saldos. Verifica la red y vuelve a intentarlo.",

    // Mensajes runtime – aprobación USDT
    amountInvalid: "Monto inválido. Ingresa un valor mayor a 0.",
    approveSending: "Enviando transacción de aprobación...",
    approveConfirmed: "Aprobación de USDT confirmada en la blockchain.",
    approveError:
      "Error al aprobar USDT. Revisa tu wallet (red, saldo, gas) y vuelve a intentar.",

    // Mensajes runtime – donación
    donateConfirm:
      "Esta operación es una donación sin retorno económico. ¿Deseas continuar?",
    donateSending: "Enviando donación...",
    donateDone: "Donación completada. ¡Gracias por tu apoyo!",
    donateError:
      "Error al enviar la donación. Revisa tu wallet (aprobación previa, red, saldo, gas).",

    // Mensajes runtime – datos de colaborador
    sendCollabOk: "Datos enviados. ¡Gracias por colaborar!",
    sendCollabError:
      "No se pudieron enviar tus datos. Inténtalo de nuevo más tarde.",
    sendCollabSheetErrorPrefix: "Error guardando en la hoja: ",

    // Mensajes runtime – lista pública de colaboradores
    loadListLoading: "Cargando...",
    loadListEmpty: "Todavía no hay colaboradores públicos.",
    loadListError: "No se pudo cargar la lista de colaboradores."
  },

  en: {
    // Static UI texts
    title: "Donations – Research Project",
    intro:
      "This form allows you to make a <strong>voluntary donation</strong> to support this independent scientific project.<br><br><strong>IMPORTANT:</strong> Every contribution is a pure and selfless donation. There is and will be no economic return, profit sharing, interest, dividends, promise of appreciation, or any kind of financial yield. This page does <strong>not</strong> offer or represent an investment instrument.",
    noReturnNote:
      "By donating, you declare that you understand and accept that:<br>• The donated funds are not refundable.<br>• No economic rights of any kind are generated.<br>• The UUT token you receive is a <strong>symbolic recognition</strong> on the blockchain, with no guaranteed financial value.",
    dataNote:
      "If you wish, you may leave your information to be mentioned in the official list of project contributors.",
    yourAddressLabel: "Your address:",
    yourUSDTLabel: "USDT Balance:",
    yourSYMLabel: "UUT Token Balance (symbolic):",
    donateTitle: "Make a Donation",
    rateNote:
      "You will receive 1 symbolic UUT token for each 1 USDT donated. This token is only a recognition on the blockchain and does not represent or guarantee financial value, rights over the project, or profit participation.",
    connectBtn: "Connect Wallet",
    approveBtn: "Approve USDT",
    donateBtn: "Donate",
    donateWarning:
      "Before donating, make sure you are connected to the BNB Smart Chain (BSC) network in your wallet and that you understand this operation is a donation with no financial return.",

    // Contributors section
    collabTitle: "Contributors",
    collabText:
      "If you wish to be included in the public list of contributors, please enter your details. You choose the level of privacy.",
    privacyPublicFull: "Public (name and country)",
    privacyPublicName: "Public (name only)",
    privacyPrivate: "Private (do not display)",
    collabNamePlaceholder: "Your name",
    collabCountryPlaceholder: "Country (optional)",
    collabCityPlaceholder: "City (optional)",
    collabAgePlaceholder: "Age (optional)",
    collabCommentPlaceholder: "Comment (optional)",
    collabEmailPlaceholder: "Email (only if you want a reply)",

    // How to import token
    howToImportTitle: "How to see your UUT token?",
    howToImportText:
      'If you don’t see your tokens after donating, open your wallet → "Import Tokens" → paste the following address:<br><strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>The token will appear with the symbol <strong>UUT</strong>.',

    // Transparency
    transparencyTitle: "Transparency and non-profit statement",
    transparencyText:
      "This project is fully funded by donations. No contribution generates returns, dividends, or financial benefits. All funds are used exclusively for scientific research, infrastructure maintenance, supplies, training, outreach, and operational support. All financial management is transparent and can be audited on the blockchain.",

    // Public list
    publicListTitle: "Public Contributors",

    // Runtime messages – wallet connection
    statusWalletMissing:
      "No compatible wallet detected. Please install or enable MetaMask (or another EIP-1193 compatible wallet).",
    statusWalletConnected:
      "Wallet successfully connected on BNB Smart Chain (BSC).",
    errorWalletConnect:
      "Failed to connect the wallet. Check your wallet and try again.",
    warningWrongNetwork:
      "Warning: this dApp is designed for BNB Smart Chain (BSC – chainId 56). Please switch your wallet network.",

    // Runtime – balances
    balanceError: "Failed to update balances. Verify your network and try again.",

    // Runtime – USDT approval
    amountInvalid: "Invalid amount. Enter a value greater than 0.",
    approveSending: "Sending approval transaction...",
    approveConfirmed: "USDT approval confirmed on-chain.",
    approveError:
      "Error while approving USDT. Check your wallet (network, balance, gas) and try again.",

    // Runtime – donation
    donateConfirm:
      "This operation is a donation with no financial return. Do you want to continue?",
    donateSending: "Sending donation...",
    donateDone: "Donation completed. Thank you for your support!",
    donateError:
      "Error sending the donation. Check your wallet (approval, network, balance, gas).",

    // Runtime – collaborator data
    sendCollabOk: "Data submitted. Thank you for collaborating!",
    sendCollabError:
      "Could not submit your data. Please try again later.",
    sendCollabSheetErrorPrefix: "Error saving data: ",

    // Runtime – public contributors list
    loadListLoading: "Loading...",
    loadListEmpty: "There are no public contributors yet.",
    loadListError: "Failed to load the contributor list."
  }
};

document.getElementById("language").onchange = applyLanguage;
applyLanguage();

function applyLanguage() {
  const lang = document.getElementById("language").value;
  const t = texts[lang];

  // Título de la pestaña
  document.title = t.title;

  // Sección superior
  document.getElementById("title").innerText = t.title;
  document.getElementById("intro").innerHTML = t.intro;
  document.getElementById("noReturnNote").innerHTML = t.noReturnNote;
  document.getElementById("data-note").innerText = t.dataNote;
  document.getElementById("yourAddressLabel").innerText = t.yourAddressLabel;
  document.getElementById("yourUSDTLabel").innerText = t.yourUSDTLabel;
  document.getElementById("yourSYMLabel").innerText = t.yourSYMLabel;

  // Donación
  document.getElementById("donateTitle").innerText = t.donateTitle;
  document.getElementById("rateNote").innerText = t.rateNote;
  document.getElementById("donateWarning").innerHTML = t.donateWarning;
  document.getElementById("connectBtn").innerText = t.connectBtn;
  document.getElementById("approveBtn").innerText = t.approveBtn;
  document.getElementById("donateBtn").innerText = t.donateBtn;

  // Panel colaboradores
  document.getElementById("collabTitle").innerText = t.collabTitle;
  document.getElementById("collabText").innerText = t.collabText;
  document.getElementById("privacyPublicFullLabel").innerText = t.privacyPublicFull;
  document.getElementById("privacyPublicNameLabel").innerText = t.privacyPublicName;
  document.getElementById("privacyPrivateLabel").innerText = t.privacyPrivate;

  document.getElementById("collabName").placeholder = t.collabNamePlaceholder;
  document.getElementById("collabCountry").placeholder = t.collabCountryPlaceholder;
  document.getElementById("collabCity").placeholder = t.collabCityPlaceholder;
  document.getElementById("collabAge").placeholder = t.collabAgePlaceholder;
  document.getElementById("collabComment").placeholder = t.collabCommentPlaceholder;
  document.getElementById("collabEmail").placeholder = t.collabEmailPlaceholder;

  // Cómo ver token
  document.getElementById("howToImportTitle").innerText = t.howToImportTitle;
  document.getElementById("howToImportText").innerHTML = t.howToImportText;

  // Transparencia
  document.getElementById("transparencyTitle").innerText = t.transparencyTitle;
  document.getElementById("transparencyText").innerText = t.transparencyText;

  // Lista pública
  document.getElementById("publicListTitle").innerText = t.publicListTitle;
}

function getT() {
  const lang = document.getElementById("language").value || "es";
  return texts[lang];
}


// ====================== CONNECT WALLET ========================
document.getElementById("connectBtn").onclick = async () => {
  try {
 if (typeof window.ethereum === "undefined") {
  const t = getT();
  showError(t.statusWalletMissing);
  return;
}


    provider = new ethers.providers.Web3Provider(window.ethereum);

    // Solicitar conexión
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    document.getElementById("userAddress").innerText = userAddress;

    // Comprobar red
    const network = await provider.getNetwork();
const t = getT();

if (network.chainId !== 56) {
  showError(t.warningWrongNetwork);
} else {
  showStatus(t.statusWalletConnected);
}

    actualizarBalances();
  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.errorWalletConnect);
   
  }
};

// ====================== BALANCES ===============================
async function actualizarBalances() {
  try {
    if (!provider || !userAddress) return;

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
    const sym  = new ethers.Contract(SYM_ADDRESS, ERC20_ABI, provider);

    const usdtDec = await usdt.decimals();
    const symDec  = await sym.decimals();

    const balUSDT = await usdt.balanceOf(userAddress);
    const balSYM  = await sym.balanceOf(userAddress);

    document.getElementById("userUSDT").innerText =
      ethers.utils.formatUnits(balUSDT, usdtDec) + " USDT";

   //document.getElementById("userSYM").innerText =
     // ethers.utils.formatUnits(balSYM, symDec) + " UUT";
  } catch (err) {
    console.error(err);
      const t = getT();
    showError(t.balanceError);

  }
}

// ====================== APPROVE ===============================
document.getElementById("approveBtn").onclick = async () => {
  try {
    if (!signer || !userAddress) {
          const t = getT();
    showError(t.errorWalletConnect);
     // showError("Primero conecta tu wallet.");
      return;
    }

    const amountInput = document.getElementById("donationAmount").value;
    if (!amountInput || amountInput <= 0) {
          const t = getT();
    showError(t.amountInvalid);
      //showError("Monto inválido. Ingresa un valor mayor a 0.");
      return;
    }

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
    const decimals = await usdt.decimals();
    const amountWei = ethers.utils.parseUnits(amountInput, decimals);
 const t = getT();
    showStatus(t.approveSending);
    //showStatus("Enviando transacción de aprobación...");
    
    const tx = await usdt.approve(DONATION_ADDRESS, amountWei);
    await tx.wait();
    showStatus(t.approveConfirmed);
//showStatus("Aprobación de USDT confirmada en la blockchain.");

  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.approveError);
   // showError("Error al aprobar USDT. Revisa MetaMask (red, saldo, gas) y vuelve a intentar.");
  }
};

// ====================== DONATE ===============================
document.getElementById("donateBtn").onclick = async () => {
  try {
    if (!signer || !userAddress) {
     const t = getT();
    showError(t.errorWalletConnect);
     // showError("Primero conecta tu wallet.");
      return;
    }

    const amountInput = document.getElementById("donationAmount").value;
    if (!amountInput || amountInput <= 0) {
     const t = getT();
    showError(t.amountInvalid);
     // showError("Monto inválido. Ingresa un valor mayor a 0.");
      return;
    }

    // Aviso explícito (confirmación del usuario en el navegador)
    const t = getT();
    const confirmar = confirm(
    t.donateConfirm
         );
         // "Esta operación es una donación sin retorno económico. ¿Deseas continuar?"
    if (!confirmar) return;

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
    const decimals = await usdt.decimals();
    const amountWei = ethers.utils.parseUnits(amountInput, decimals);
    ultimoMontoUSDT = amountInput ;
    const donation = new ethers.Contract(DONATION_ADDRESS, DONATION_ABI, signer);
 
 
    showStatus(t.donateSending);
   //showStatus("Enviando donación...");
    const tx = await donation.donate(amountWei);
    ultimoTxHash = tx.hash; 
    await tx.wait();
   
    showStatus(t.donateDone);
   //    showStatus("Donación completada. ¡Gracias por tu apoyo!");
 actualizarBalances();
    openCollabPanel();
} catch (err) {
  console.error(err);
  const t = getT();
  showError(t.donateError);
}

};

// ====================== SEND COLLAB DATA ======================
document.getElementById("sendCollab").onclick = async () => {
  try {
    const privacy = document.querySelector("input[name='privacy']:checked").value;

    const payload = {
      wallet: userAddress || "",
      nombre: document.getElementById("collabName").value,
      email: document.getElementById("collabEmail").value,
      privacidad: privacy,
      pais: document.getElementById("collabCountry").value,
      ciudad: document.getElementById("collabCity").value,
      edad: document.getElementById("collabAge").value,
      comentario: document.getElementById("collabComment").value,
      montoUSDT: ultimoMontoUSDT,
      txHash: ultimoTxHash || "",     // ← definilo cuando confirmás donate()
      userAgent:  navigator.userAgent || ""
    };
const resp = await fetch(GOOGLE_WEBAPP_URL, {
  method: "POST",
  // sin headers personalizados
  body: JSON.stringify(payload)
});


   const data = await resp.json();
if (data.status === "ok") {
 const t = getT();
    showStatus(t.sendCollabOk)
  //showStatus("Datos enviados. ¡Gracias por colaborar!");

  // Opcional: limpiar campos
  document.getElementById("collabName").value = "";
  document.getElementById("collabCountry").value = "";
  document.getElementById("collabCity").value = "";
  document.getElementById("collabAge").value = "";
  document.getElementById("collabComment").value = "";
  document.getElementById("collabEmail").value = "";

  // Cerramos el panel cuando todo salió bien
  closeCollabPanel();
  cargarColaboradoresPublicos();
 } else {
      const t = getT();
      showError(t.sendCollabError);
    }

  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.sendCollabError);
  }
};
const collabPanel = document.getElementById("collabPanel");
function openCollabPanel() {
  if (!collabPanel) return;
  collabPanel.classList.remove("collapsed");
  collabPanel.classList.add("expanded");
  // Scroll suave al panel
  collabPanel.scrollIntoView({ behavior: "smooth", block: "start" });
}

function closeCollabPanel() {
  if (!collabPanel) return;
  collabPanel.classList.remove("expanded");
  collabPanel.classList.add("collapsed");
}


// ================= CARGAR COLABORADORES PÚBLICOS ==============
async function cargarColaboradoresPublicos() {
  const contenedor = document.getElementById("publicCollabList");
      const t = getT();
      contenedor.textContent =  t.loadListLoading
 // contenedor.textContent = "Cargando...";

  try {
const res = await fetch(GOOGLE_WEBAPP_URL);
const data = await res.json();

    contenedor.innerHTML = "";

    if (!data.length) {
    const t = getT();
      contenedor.textContent =  t.loadListEmpty
      //"Todavía no hay colaboradores públicos.";
      return;
    }

    data.forEach(c => {
      const card = document.createElement("div");
      card.className = "collab-card";
      card.style.padding = "8px 0";

      const line = document.createElement("div");

      // Texto seguro según modo de privacidad
      let texto = c.nombre || "";
      if (c.modo === "public_full" && c.pais) {
        texto += " (" + c.pais + ")";
      }

      line.textContent = texto; // protección contra XSS
      card.appendChild(line);
      contenedor.appendChild(card);
    });

  } catch (err) {
   const t = getT();
    contenedor.textContent = t.loadListError
    //"No se pudo cargar la lista de colaboradores.";
    console.error(err);
  }
}

// Llamar al cargar la página
cargarColaboradoresPublicos();
</script>
</body>
</html>
