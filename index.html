<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Donaciones ‚Äì Proyecto de Investigaci√≥n</title>
<link rel="icon" type="image/png" href="favicon.png" />
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
  body {
    font-family: 'Segoe UI', Arial, sans-serif;
    background: #f5f5f7;
    color: #222;
    margin: 0;
    padding: 0;
  }
  header {
    background: #111827;
    color: #fff;
    padding: 35px;
    text-align: center;
  }
  header h1 { margin: 0; font-size: 28px; }
  .container {
    max-width: 820px;
    margin: 40px auto;
    background: #fff;
    padding: 40px;
    border-radius: 14px;
    box-shadow: 0 0 25px rgba(0,0,0,0.08);
  }
  h2, h3 { margin-top: 0; }
  input, select, textarea {
    width: 100%;
    padding: 12px;
    margin: 8px 0 15px 0;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 15px;
  }
  button {
    width: 100%;
    padding: 14px;
    margin-top: 10px;
    border: none;
    border-radius: 8px;
    background: #2563eb;
    color: #fff;
    font-size: 17px;
    cursor: pointer;
    font-weight: 600;
  }
  button:hover { background: #1e40af; }
  .lang-switch {
    text-align: right;
    margin-bottom: 10px;
  }
  .note {
    font-size: 14px;
    color: #444;
    margin-top: 15px;
  }
  .success {
    background: #d1fae5;
    color: #065f46;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  .error {
    background: #fee2e2;
    color: #991b1b;
    padding: 10px;
    border-radius: 6px;
    margin-top: 10px;
    display: none;
  }
  #collabPanel {
  transition: max-height 0.4s ease, opacity 0.4s ease;
  overflow: hidden;
}

#collabPanel.collapsed {
  max-height: 0;
  opacity: 0;
  pointer-events: none;
}

#collabPanel.expanded {
  max-height: 1000px; /* algo grande para que entre todo */
  opacity: 1;
  pointer-events: auto;
}

</style>
</head>
<body>
<header>
  <h1 id="title">Donaciones ‚Äì Proyecto de Investigaci√≥n</h1>
</header>
<div class="container">

<div class="lang-switch">
    <select id="language">
      <option value="es">Espa√±ol</option>
      <option value="en">English</option>
    </select>
</div>

<p id="intro">
  Este formulario permite realizar una <strong>donaci√≥n voluntaria</strong> para apoyar este proyecto cient√≠fico independiente.
  <br><br>
  <strong>IMPORTANTE:</strong> Toda contribuci√≥n es una donaci√≥n pura y desinteresada. No existe, ni existir√°, retorno econ√≥mico,
  participaci√≥n en beneficios, intereses, dividendos, promesa de revalorizaci√≥n, ni ning√∫n tipo de rendimiento financiero.
  Esta p√°gina <strong>no</strong> ofrece ni representa un instrumento de inversi√≥n.
</p>

<p class="note" id="noReturnNote">
  Al donar, declaras que comprendes y aceptas que:
  <br>‚Ä¢ No hay devoluci√≥n del dinero donado.
  <br>‚Ä¢ No se generan derechos econ√≥micos de ning√∫n tipo.
  <br>‚Ä¢ El token UUT que recibes es un <strong>reconocimiento simb√≥lico</strong> en la blockchain, sin valor financiero garantizado.
</p>

<p id="data-note">
  Si lo deseas, puedes dejar tus datos para ser mencionado en la lista oficial de colaboradores del proyecto.
</p>

<button id="connectBtn">Conectar Wallet</button>
<div id="status" class="success"></div>
<div id="errorMsg" class="error"></div>

<h3 id="yourAddressLabel">Tu direcci√≥n:</h3>
<div id="userAddress">‚Äî</div>

<h3 id="yourUSDTLabel">Saldo USDT:</h3>
<div id="userUSDT">‚Äî</div>

<h3 id="yourSYMLabel">Token UUT (simb√≥lico):</h3>
<!-- <div id="userSYM">‚Äî</div>-->

<hr>
<h3 id="donateTitle">Realizar donaci√≥n</h3>

<p class="note" id="donateWarning">
  Antes de donar, aseg√∫rate de estar conectado a la red <strong>BNB Smart Chain (BSC)</strong> en tu Billetera y de comprender que esta operaci√≥n es una donaci√≥n sin retorno econ√≥mico.
</p>

<input type="number" id="donationAmount" placeholder="Monto en USDT (ej: 1.5)" />
<button id="approveBtn">Aprobar USDT</button>
<button id="donateBtn">Donar</button>
<div id="statusBottom" class="success"></div>
<div id="errorMsgBottom" class="error"></div>
<p class="note" id="rateNote">
  Recibir√°s <strong>1 token UUT simb√≥lico por cada 1 USDT donado</strong>.
  Este token es √∫nicamente un reconocimiento simb√≥lico en la red y <strong>no representa ni garantiza valor financiero, derechos sobre el proyecto ni participaci√≥n en beneficios</strong>.
</p>

<hr>

<div id="collabPanel" class="collapsed">
  <h3 id="collabTitle">Colaboradores</h3>
  <p id="collabText">Si deseas ser incluido en la lista p√∫blica de colaboradores, ingresa tus datos. T√∫ eliges el nivel de privacidad.</p>

<label>
  <input type="radio" name="privacy" value="public_full" checked>
  <span id="privacyPublicFullLabel">P√∫blico (nombre y pa√≠s)</span>
</label><br>

<label>
  <input type="radio" name="privacy" value="public_name">
  <span id="privacyPublicNameLabel">P√∫blico (solo nombre)</span>
</label><br>

<label>
  <input type="radio" name="privacy" value="private">
  <span id="privacyPrivateLabel">Privado (no mostrar)</span>
</label><br><br>

  <input type="text" id="collabName" name="collabName" autocomplete="name" placeholder="Tu nombre" />
  <input type="text" id="collabCountry" placeholder="Pa√≠s (opcional)" autocomplete="country-name" />
  <input type="text" id="collabCity" placeholder="Ciudad (opcional)" autocomplete="address-level2" />
  <input type="number" id="collabAge" placeholder="Edad (opcional)" />
  <textarea id="collabComment" placeholder="Comentario (opcional)" style="width:100%;height:80px;margin-top:10px;"></textarea>
  <input type="email" id="collabEmail" name="collabEmail" autocomplete="email" placeholder="Correo (solo si deseas recibir una respuesta)" />
  <button id="sendCollab">Enviar datos</button>
</div>


<hr>
<h3 id="howToImportTitle">¬øC√≥mo ver tu token UUT?</h3>
<p id="howToImportText">
  Si no ves tus tokens luego de donar, abre tu billetera ‚Üí "Import Tokens" ‚Üí pega la siguiente direcci√≥n:<br>
  <strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>
  El token aparecer√° autom√°ticamente con el s√≠mbolo <strong>UUT</strong>.
</p>

<h3 id="transparencyTitle">Transparencia y declaraci√≥n de no lucro</h3>
<p id="transparencyText">
  Este proyecto se sostiene √≠ntegramente mediante donaciones. Ning√∫n aporte genera retorno, dividendos ni beneficios financieros.
  Todos los fondos se destinan exclusivamente a investigaci√≥n cient√≠fica, mantenimiento de infraestructura, insumos, capacitaci√≥n,
  divulgaci√≥n y sostenimiento operativo. Toda la gesti√≥n financiera es transparente y puede ser auditada en la blockchain.
</p>

<hr>
<h3 id="publicListTitle">Colaboradores P√∫blicos</h3>
<div id="publicCollabList">Cargando...</div>
</div>

<script>
// URL de tu Google Apps Script
const GOOGLE_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwy8aXsvn9KDTdbdf4oP9DmhAmBV7ZhVbAaNAxCbjPIlSNFM9OMlBFV5xcA_0gymMW_/exec";

// ========================= CONFIG ============================
const USDT_ADDRESS      = "0x55d398326f99059fF775485246999027B3197955"; // USDT en BNB Smart Chain
const SYM_ADDRESS       = "0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3"; // Token UUT
const DONATION_ADDRESS  = "0x524C8B19d28d4C24E73cd2126E3C6b87A40EdD0f"; // Contrato de donaciones
const BSC_CHAIN_ID_HEX  = "0x38"; // 56 en decimal

const ERC20_ABI = [
  "function approve(address spender, uint256 amount) external returns (bool)",
  "function balanceOf(address) external view returns (uint256)",
  "function decimals() external view returns (uint8)"
];

const DONATION_ABI = [
  "function donate(uint256 amountUSDT) external"
];

let provider, signer, userAddress;
let ultimoTxHash = "";
let ultimoMontoUSDT = "";

// Helpers de UI
const statusBox = document.getElementById("status");
const errorBox  = document.getElementById("errorMsg");

function showStatus(msg) {
  // Arriba
  statusBox.innerText = msg;
  statusBox.style.display = "block";
  errorBox.style.display = "none";

  // Abajo
  const b  = document.getElementById("statusBottom");
  const eb = document.getElementById("errorMsgBottom");
  if (b && eb) {
    b.innerText = msg;
    b.style.display = "block";
    eb.style.display = "none";

    // Scroll suave al bloque inferior de mensajes
    b.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}

function showError(msg) {
  // Arriba
  errorBox.innerText = msg;
  errorBox.style.display = "block";
  statusBox.style.display = "none";

  // Abajo
  const b  = document.getElementById("statusBottom");
  const eb = document.getElementById("errorMsgBottom");
  if (b && eb) {
    eb.innerText = msg;
    eb.style.display = "block";
    b.style.display = "none";

    // Scroll suave al bloque inferior de mensajes
    eb.scrollIntoView({ behavior: "smooth", block: "center" });
  }
}
// ====================== MULTI-LANGUAGE ========================
const texts = {
  es: {
    // T√≠tulos y textos est√°ticos
    title: "Donaciones ‚Äì Proyecto de Investigaci√≥n",
    intro:
      "Este formulario permite realizar una <strong>donaci√≥n voluntaria</strong> para apoyar este proyecto cient√≠fico independiente.<br><br><strong>IMPORTANTE:</strong> Toda contribuci√≥n es una donaci√≥n pura y desinteresada. No existe, ni existir√°, retorno econ√≥mico, participaci√≥n en beneficios, intereses, dividendos, promesa de revalorizaci√≥n, ni ning√∫n tipo de rendimiento financiero. Esta p√°gina <strong>no</strong> ofrece ni representa un instrumento de inversi√≥n.",
    noReturnNote:
      "Al donar, declaras que comprendes y aceptas que:<br>‚Ä¢ No hay devoluci√≥n del dinero donado.<br>‚Ä¢ No se generan derechos econ√≥micos de ning√∫n tipo.<br>‚Ä¢ El token UUT que recibes es un <strong>reconocimiento simb√≥lico</strong> en la blockchain, sin valor financiero garantizado.",
    dataNote:
      "Si lo deseas, puedes dejar tus datos para ser mencionado en la lista oficial de colaboradores del proyecto.",
    yourAddressLabel: "Tu direcci√≥n:",
    yourUSDTLabel: "Saldo USDT:",
    yourSYMLabel: "Token UUT (simb√≥lico):",
    donateTitle: "Realizar donaci√≥n",
    rateNote:
      "Recibir√°s 1 token UUT simb√≥lico por cada 1 USDT donado. El token es √∫nicamente un reconocimiento en la blockchain y no representa ni garantiza valor financiero, derechos sobre el proyecto ni participaci√≥n en beneficios.",
    connectBtn: "Conectar Wallet",
    approveBtn: "Aprobar USDT",
    donateBtn: "Donar",
    donateWarning:
      "Antes de donar, aseg√∫rate de estar conectado a la red BNB Smart Chain (BSC) en tu billetera y de comprender que esta operaci√≥n es una donaci√≥n sin retorno econ√≥mico.",

    // Secci√≥n colaboradores
    collabTitle: "Colaboradores",
    collabText:
      "Si deseas ser incluido en la lista p√∫blica de colaboradores, ingresa tus datos. T√∫ eliges el nivel de privacidad.",
    privacyPublicFull: "P√∫blico (nombre y pa√≠s)",
    privacyPublicName: "P√∫blico (solo nombre)",
    privacyPrivate: "Privado (no mostrar)",
    collabNamePlaceholder: "Tu nombre",
    collabCountryPlaceholder: "Pa√≠s (opcional)",
    collabCityPlaceholder: "Ciudad (opcional)",
    collabAgePlaceholder: "Edad (opcional)",
    collabCommentPlaceholder: "Comentario (opcional)",
    collabEmailPlaceholder: "Correo (solo si deseas recibir una respuesta)",

    // C√≥mo ver el token
    howToImportTitle: "¬øC√≥mo ver tu token UUT?",
    howToImportText:
      'Si no ves tus tokens luego de donar, abre tu billetera ‚Üí "Import Tokens" ‚Üí pega la siguiente direcci√≥n:<br><strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>El token aparecer√° autom√°ticamente con el s√≠mbolo <strong>UUT</strong>.',

    // Transparencia
    transparencyTitle: "Transparencia y declaraci√≥n de no lucro",
    transparencyText:
      "Este proyecto se sostiene √≠ntegramente mediante donaciones. Ning√∫n aporte genera retorno, dividendos ni beneficios financieros. Todos los fondos se destinan exclusivamente a investigaci√≥n cient√≠fica, mantenimiento de infraestructura, insumos, capacitaci√≥n, divulgaci√≥n y sostenimiento operativo. Toda la gesti√≥n financiera es transparente y puede ser auditada en la blockchain.",

    // Lista p√∫blica
    publicListTitle: "Colaboradores P√∫blicos",

    // Mensajes runtime ‚Äì conexi√≥n de wallet
    statusWalletMissing:
      "No se detect√≥ ninguna wallet compatible. Instala o habilita MetaMask (u otra wallet compatible).",
    statusWalletConnected:
      "Wallet conectada correctamente en BNB Smart Chain (BSC).",
    errorWalletConnect:
      "No se pudo conectar la wallet. Revisa tu wallet y vuelve a intentarlo.",
    warningWrongNetwork:
      "Atenci√≥n: esta dApp est√° dise√±ada para la red BNB Smart Chain (BSC ‚Äì chainId 56). Cambia la red en tu wallet.",

    // Mensajes runtime ‚Äì balances
    balanceError:
      "No se pudieron actualizar los saldos. Verifica la red y vuelve a intentarlo.",

    // Mensajes runtime ‚Äì aprobaci√≥n USDT
    amountInvalid: "Monto inv√°lido. Ingresa un valor mayor a 0.",
    approveSending: "Enviando transacci√≥n de aprobaci√≥n...",
    approveConfirmed: "Aprobaci√≥n de USDT confirmada en la blockchain.",
    approveError:
      "Error al aprobar USDT. Revisa tu wallet (red, saldo, gas) y vuelve a intentar.",

    // Mensajes runtime ‚Äì donaci√≥n
    donateConfirm:
      "Esta operaci√≥n es una donaci√≥n sin retorno econ√≥mico. ¬øDeseas continuar?",
    donateSending: "Enviando donaci√≥n...",
    donateDone: "Donaci√≥n completada. ¬°Gracias por tu apoyo!",
    donateError:
      "Error al enviar la donaci√≥n. Revisa tu wallet (aprobaci√≥n previa, red, saldo, gas).",

    // Mensajes runtime ‚Äì datos de colaborador
    sendCollabOk: "Datos enviados. ¬°Gracias por colaborar!",
    sendCollabError:
      "No se pudieron enviar tus datos. Int√©ntalo de nuevo m√°s tarde.",
    sendCollabSheetErrorPrefix: "Error guardando en la hoja: ",

    // Mensajes runtime ‚Äì lista p√∫blica de colaboradores
    loadListLoading: "Cargando...",
    loadListEmpty: "Todav√≠a no hay colaboradores p√∫blicos.",
    loadListError: "No se pudo cargar la lista de colaboradores."
  },

  en: {
    // Static UI texts
    title: "Donations ‚Äì Research Project",
    intro:
      "This form allows you to make a <strong>voluntary donation</strong> to support this independent scientific project.<br><br><strong>IMPORTANT:</strong> Every contribution is a pure and selfless donation. There is and will be no economic return, profit sharing, interest, dividends, promise of appreciation, or any kind of financial yield. This page does <strong>not</strong> offer or represent an investment instrument.",
    noReturnNote:
      "By donating, you declare that you understand and accept that:<br>‚Ä¢ The donated funds are not refundable.<br>‚Ä¢ No economic rights of any kind are generated.<br>‚Ä¢ The UUT token you receive is a <strong>symbolic recognition</strong> on the blockchain, with no guaranteed financial value.",
    dataNote:
      "If you wish, you may leave your information to be mentioned in the official list of project contributors.",
    yourAddressLabel: "Your address:",
    yourUSDTLabel: "USDT Balance:",
    yourSYMLabel: "UUT Token Balance (symbolic):",
    donateTitle: "Make a Donation",
    rateNote:
      "You will receive 1 symbolic UUT token for each 1 USDT donated. This token is only a recognition on the blockchain and does not represent or guarantee financial value, rights over the project, or profit participation.",
    connectBtn: "Connect Wallet",
    approveBtn: "Approve USDT",
    donateBtn: "Donate",
    donateWarning:
      "Before donating, make sure you are connected to the BNB Smart Chain (BSC) network in your wallet and that you understand this operation is a donation with no financial return.",

    // Contributors section
    collabTitle: "Contributors",
    collabText:
      "If you wish to be included in the public list of contributors, please enter your details. You choose the level of privacy.",
    privacyPublicFull: "Public (name and country)",
    privacyPublicName: "Public (name only)",
    privacyPrivate: "Private (do not display)",
    collabNamePlaceholder: "Your name",
    collabCountryPlaceholder: "Country (optional)",
    collabCityPlaceholder: "City (optional)",
    collabAgePlaceholder: "Age (optional)",
    collabCommentPlaceholder: "Comment (optional)",
    collabEmailPlaceholder: "Email (only if you want a reply)",

    // How to import token
    howToImportTitle: "How to see your UUT token?",
    howToImportText:
      'If you don‚Äôt see your tokens after donating, open your wallet ‚Üí "Import Tokens" ‚Üí paste the following address:<br><strong>0xbEf018e8d5c4b89F84023ad735aA261bb10bD2a3</strong><br>The token will appear with the symbol <strong>UUT</strong>.',

    // Transparency
    transparencyTitle: "Transparency and non-profit statement",
    transparencyText:
      "This project is fully funded by donations. No contribution generates returns, dividends, or financial benefits. All funds are used exclusively for scientific research, infrastructure maintenance, supplies, training, outreach, and operational support. All financial management is transparent and can be audited on the blockchain.",

    // Public list
    publicListTitle: "Public Contributors",

    // Runtime messages ‚Äì wallet connection
    statusWalletMissing:
      "No compatible wallet detected. Please install or enable MetaMask (or another EIP-1193 compatible wallet).",
    statusWalletConnected:
      "Wallet successfully connected on BNB Smart Chain (BSC).",
    errorWalletConnect:
      "Failed to connect the wallet. Check your wallet and try again.",
    warningWrongNetwork:
      "Warning: this dApp is designed for BNB Smart Chain (BSC ‚Äì chainId 56). Please switch your wallet network.",

    // Runtime ‚Äì balances
    balanceError: "Failed to update balances. Verify your network and try again.",

    // Runtime ‚Äì USDT approval
    amountInvalid: "Invalid amount. Enter a value greater than 0.",
    approveSending: "Sending approval transaction...",
    approveConfirmed: "USDT approval confirmed on-chain.",
    approveError:
      "Error while approving USDT. Check your wallet (network, balance, gas) and try again.",

    // Runtime ‚Äì donation
    donateConfirm:
      "This operation is a donation with no financial return. Do you want to continue?",
    donateSending: "Sending donation...",
    donateDone: "Donation completed. Thank you for your support!",
    donateError:
      "Error sending the donation. Check your wallet (approval, network, balance, gas).",

    // Runtime ‚Äì collaborator data
    sendCollabOk: "Data submitted. Thank you for collaborating!",
    sendCollabError:
      "Could not submit your data. Please try again later.",
    sendCollabSheetErrorPrefix: "Error saving data: ",

    // Runtime ‚Äì public contributors list
    loadListLoading: "Loading...",
    loadListEmpty: "There are no public contributors yet.",
    loadListError: "Failed to load the contributor list."
  }
};

document.getElementById("language").onchange = applyLanguage;
applyLanguage();

function applyLanguage() {
  const lang = document.getElementById("language").value;
  const t = texts[lang];

  // T√≠tulo de la pesta√±a
  document.title = t.title;

  // Secci√≥n superior
  document.getElementById("title").innerText = t.title;
  document.getElementById("intro").innerHTML = t.intro;
  document.getElementById("noReturnNote").innerHTML = t.noReturnNote;
  document.getElementById("data-note").innerText = t.dataNote;
  document.getElementById("yourAddressLabel").innerText = t.yourAddressLabel;
  document.getElementById("yourUSDTLabel").innerText = t.yourUSDTLabel;
  document.getElementById("yourSYMLabel").innerText = t.yourSYMLabel;

  // Donaci√≥n
  document.getElementById("donateTitle").innerText = t.donateTitle;
  document.getElementById("rateNote").innerText = t.rateNote;
  document.getElementById("donateWarning").innerHTML = t.donateWarning;
  document.getElementById("connectBtn").innerText = t.connectBtn;
  document.getElementById("approveBtn").innerText = t.approveBtn;
  document.getElementById("donateBtn").innerText = t.donateBtn;

  // Panel colaboradores
  document.getElementById("collabTitle").innerText = t.collabTitle;
  document.getElementById("collabText").innerText = t.collabText;
  document.getElementById("privacyPublicFullLabel").innerText = t.privacyPublicFull;
  document.getElementById("privacyPublicNameLabel").innerText = t.privacyPublicName;
  document.getElementById("privacyPrivateLabel").innerText = t.privacyPrivate;

  document.getElementById("collabName").placeholder = t.collabNamePlaceholder;
  document.getElementById("collabCountry").placeholder = t.collabCountryPlaceholder;
  document.getElementById("collabCity").placeholder = t.collabCityPlaceholder;
  document.getElementById("collabAge").placeholder = t.collabAgePlaceholder;
  document.getElementById("collabComment").placeholder = t.collabCommentPlaceholder;
  document.getElementById("collabEmail").placeholder = t.collabEmailPlaceholder;

  // C√≥mo ver token
  document.getElementById("howToImportTitle").innerText = t.howToImportTitle;
  document.getElementById("howToImportText").innerHTML = t.howToImportText;

  // Transparencia
  document.getElementById("transparencyTitle").innerText = t.transparencyTitle;
  document.getElementById("transparencyText").innerText = t.transparencyText;

  // Lista p√∫blica
  document.getElementById("publicListTitle").innerText = t.publicListTitle;
}

function getT() {
  const lang = document.getElementById("language").value || "es";
  return texts[lang];
}


// ====================== CONNECT WALLET ========================
document.getElementById("connectBtn").onclick = async () => {
  try {
 if (typeof window.ethereum === "undefined") {
  const t = getT();
  showError(t.statusWalletMissing);
  return;
}


    provider = new ethers.providers.Web3Provider(window.ethereum);

    // Solicitar conexi√≥n
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();

    document.getElementById("userAddress").innerText = userAddress;

    // Comprobar red
    const network = await provider.getNetwork();
const t = getT();

if (network.chainId !== 56) {
  showError(t.warningWrongNetwork);
} else {
  showStatus(t.statusWalletConnected);
}

    actualizarBalances();
  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.errorWalletConnect);
   
  }
};

// ====================== BALANCES ===============================
async function actualizarBalances() {
  try {
    if (!provider || !userAddress) return;

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, provider);
    const sym  = new ethers.Contract(SYM_ADDRESS, ERC20_ABI, provider);

    const usdtDec = await usdt.decimals();
    const symDec  = await sym.decimals();

    const balUSDT = await usdt.balanceOf(userAddress);
    const balSYM  = await sym.balanceOf(userAddress);

    document.getElementById("userUSDT").innerText =
      ethers.utils.formatUnits(balUSDT, usdtDec) + " USDT";

   //document.getElementById("userSYM").innerText =
     // ethers.utils.formatUnits(balSYM, symDec) + " UUT";
  } catch (err) {
    console.error(err);
      const t = getT();
    showError(t.balanceError);

  }
}

// ====================== APPROVE ===============================
document.getElementById("approveBtn").onclick = async () => {
  try {
    if (!signer || !userAddress) {
          const t = getT();
    showError(t.errorWalletConnect);
     // showError("Primero conecta tu wallet.");
      return;
    }

    const amountInput = document.getElementById("donationAmount").value;
    if (!amountInput || amountInput <= 0) {
          const t = getT();
    showError(t.amountInvalid);
      //showError("Monto inv√°lido. Ingresa un valor mayor a 0.");
      return;
    }

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
    const decimals = await usdt.decimals();
    const amountWei = ethers.utils.parseUnits(amountInput, decimals);
 const t = getT();
    showStatus(t.approveSending);
    //showStatus("Enviando transacci√≥n de aprobaci√≥n...");
    
    const tx = await usdt.approve(DONATION_ADDRESS, amountWei);
    await tx.wait();
    showStatus(t.approveConfirmed);
//showStatus("Aprobaci√≥n de USDT confirmada en la blockchain.");

  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.approveError);
   // showError("Error al aprobar USDT. Revisa MetaMask (red, saldo, gas) y vuelve a intentar.");
  }
};

// ====================== DONATE ===============================
document.getElementById("donateBtn").onclick = async () => {
  try {
    if (!signer || !userAddress) {
     const t = getT();
    showError(t.errorWalletConnect);
     // showError("Primero conecta tu wallet.");
      return;
    }

    const amountInput = document.getElementById("donationAmount").value;
    if (!amountInput || amountInput <= 0) {
     const t = getT();
    showError(t.amountInvalid);
     // showError("Monto inv√°lido. Ingresa un valor mayor a 0.");
      return;
    }

    // Aviso expl√≠cito (confirmaci√≥n del usuario en el navegador)
    const t = getT();
    const confirmar = confirm(
    t.donateConfirm
         );
         // "Esta operaci√≥n es una donaci√≥n sin retorno econ√≥mico. ¬øDeseas continuar?"
    if (!confirmar) return;

    const usdt = new ethers.Contract(USDT_ADDRESS, ERC20_ABI, signer);
    const decimals = await usdt.decimals();
    const amountWei = ethers.utils.parseUnits(amountInput, decimals);
    ultimoMontoUSDT = amountInput ;
    const donation = new ethers.Contract(DONATION_ADDRESS, DONATION_ABI, signer);
 
 
    showStatus(t.donateSending);
   //showStatus("Enviando donaci√≥n...");
    const tx = await donation.donate(amountWei);
    ultimoTxHash = tx.hash; 
    await tx.wait();
   
    showStatus(t.donateDone);
   //    showStatus("Donaci√≥n completada. ¬°Gracias por tu apoyo!");
 actualizarBalances();
    openCollabPanel();
} catch (err) {
  console.error(err);
  const t = getT();
  showError(t.donateError);
}

};

// ====================== SEND COLLAB DATA ======================
document.getElementById("sendCollab").onclick = async () => {
  try {
    const privacy = document.querySelector("input[name='privacy']:checked").value;

    const payload = {
      wallet: userAddress || "",
      nombre: document.getElementById("collabName").value,
      email: document.getElementById("collabEmail").value,
      privacidad: privacy,
      pais: document.getElementById("collabCountry").value,
      ciudad: document.getElementById("collabCity").value,
      edad: document.getElementById("collabAge").value,
      comentario: document.getElementById("collabComment").value,
      montoUSDT: ultimoMontoUSDT,
      txHash: ultimoTxHash || "",     // ‚Üê definilo cuando confirm√°s donate()
      userAgent:  navigator.userAgent || ""
    };
  const resp = await fetch(GOOGLE_WEBAPP_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json"   // üëà CLAVE
      },
      body: JSON.stringify(payload)          // üëà Enviamos JSON real
    });

   const data = await resp.json();
if (data.status === "ok") {
 const t = getT();
    showStatus(t.sendCollabOk)
  //showStatus("Datos enviados. ¬°Gracias por colaborar!");

  // Opcional: limpiar campos
  document.getElementById("collabName").value = "";
  document.getElementById("collabCountry").value = "";
  document.getElementById("collabCity").value = "";
  document.getElementById("collabAge").value = "";
  document.getElementById("collabComment").value = "";
  document.getElementById("collabEmail").value = "";

  // Cerramos el panel cuando todo sali√≥ bien
  closeCollabPanel();
 } else {
      const t = getT();
      showError(t.sendCollabError);
    }

  } catch (err) {
    console.error(err);
    const t = getT();
    showError(t.sendCollabError);
  }
};
const collabPanel = document.getElementById("collabPanel");
function openCollabPanel() {
  if (!collabPanel) return;
  collabPanel.classList.remove("collapsed");
  collabPanel.classList.add("expanded");
  // Scroll suave al panel
  collabPanel.scrollIntoView({ behavior: "smooth", block: "start" });
}

function closeCollabPanel() {
  if (!collabPanel) return;
  collabPanel.classList.remove("expanded");
  collabPanel.classList.add("collapsed");
}


// ================= CARGAR COLABORADORES P√öBLICOS ==============
async function cargarColaboradoresPublicos() {
  const contenedor = document.getElementById("publicCollabList");
      const t = getT();
      contenedor.textContent =  t.loadListLoading
 // contenedor.textContent = "Cargando...";

  try {
const res = await fetch(GOOGLE_WEBAPP_URL);
const data = await res.json();

    contenedor.innerHTML = "";

    if (!data.length) {
    const t = getT();
      contenedor.textContent =  t.loadListEmpty
      //"Todav√≠a no hay colaboradores p√∫blicos.";
      return;
    }

    data.forEach(c => {
      const card = document.createElement("div");
      card.className = "collab-card";
      card.style.padding = "8px 0";

      const line = document.createElement("div");

      // Texto seguro seg√∫n modo de privacidad
      let texto = c.nombre || "";
      if (c.modo === "public_full" && c.pais) {
        texto += " (" + c.pais + ")";
      }

      line.textContent = texto; // protecci√≥n contra XSS
      card.appendChild(line);
      contenedor.appendChild(card);
    });

  } catch (err) {
   const t = getT();
    contenedor.textContent = t.loadListError
    //"No se pudo cargar la lista de colaboradores.";
    console.error(err);
  }
}

// Llamar al cargar la p√°gina
cargarColaboradoresPublicos();
</script>
</body>
</html>
